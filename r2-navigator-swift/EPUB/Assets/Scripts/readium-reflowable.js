(()=>{var t={89:(t,e)=>{"use strict";function n(t){return t.split("").reverse().join("")}function o(t){return(t|-t)>>31&1}function r(t,e,n,r){var i=t.P[n],s=t.M[n],l=r>>>31,a=e[n]|l,c=a|s,d=(a&i)+i^i|a,f=s|~(d|i),h=i&d,u=o(f&t.lastRowMask[n])-o(h&t.lastRowMask[n]);return f<<=1,h<<=1,i=(h|=l)|~(c|(f|=o(r)-l)),s=f&c,t.P[n]=i,t.M[n]=s,u}function i(t,e,n){if(0===e.length)return[];n=Math.min(n,e.length);var o=[],i=32,s=Math.ceil(e.length/i)-1,l={P:new Uint32Array(s+1),M:new Uint32Array(s+1),lastRowMask:new Uint32Array(s+1)};l.lastRowMask.fill(1<<31),l.lastRowMask[s]=1<<(e.length-1)%i;for(var a=new Uint32Array(s+1),c=new Map,d=[],f=0;f<256;f++)d.push(a);for(var h=0;h<e.length;h+=1){var u=e.charCodeAt(h);if(!c.has(u)){var g=new Uint32Array(s+1);c.set(u,g),u<d.length&&(d[u]=g);for(var m=0;m<=s;m+=1){g[m]=0;for(var p=0;p<i;p+=1){var E=m*i+p;E>=e.length||e.charCodeAt(E)===u&&(g[m]|=1<<p)}}}}var w=Math.max(0,Math.ceil(n/i)-1),N=new Uint32Array(s+1);for(m=0;m<=w;m+=1)N[m]=(m+1)*i;for(N[s]=e.length,m=0;m<=w;m+=1)l.P[m]=-1,l.M[m]=0;for(var C=0;C<t.length;C+=1){var T=t.charCodeAt(C);g=void 0,T<d.length?g=d[T]:void 0===(g=c.get(T))&&(g=a);var x=0;for(m=0;m<=w;m+=1)x=r(l,g,m,x),N[m]+=x;if(N[w]-x<=n&&w<s&&(1&g[w+1]||x<0)){w+=1,l.P[w]=-1,l.M[w]=0;var v=w===s?e.length%i:i;N[w]=N[w-1]+v-x+r(l,g,w,x)}else for(;w>0&&N[w]>=n+i;)w-=1;w===s&&N[w]<=n&&(N[w]<n&&o.splice(0,o.length),o.push({start:-1,end:C+1,errors:N[w]}),n=N[w])}return o}e.Z=function(t,e,o){return function(t,e,o){var r=n(e);return o.map((function(o){var s=Math.max(0,o.end-e.length-o.errors);return{start:i(n(t.slice(s,o.end)),r,o.errors).reduce((function(t,e){return o.end-e.end<t?o.end-e.end:t}),o.end),end:o.end,errors:o.errors}}))}(t,e,i(t,e,o))}},581:()=>{function t(t){window.getSelection().isCollapsed&&webkit.messageHandlers.tap.postMessage({defaultPrevented:t.defaultPrevented,screenX:t.screenX,screenY:t.screenY,clientX:t.clientX,clientY:t.clientY,targetElement:t.target.outerHTML,interactiveElement:e(t.target)})}function e(t){return-1!==["a","audio","button","canvas","details","input","label","option","select","submit","textarea","video"].indexOf(t.nodeName.toLowerCase())||t.hasAttribute("contenteditable")&&"false"!=t.getAttribute("contenteditable").toLowerCase()?t.outerHTML:t.parentElement?e(t.parentElement):null}window.addEventListener("DOMContentLoaded",(function(e){document.body.style.cursor="pointer",document.addEventListener("click",t,!1)}))}},e={};function n(o){var r=e[o];if(void 0!==r)return r.exports;var i=e[o]={exports:{}};return t[o](i,i.exports,n),i.exports}(()=>{"use strict";n(581),window.addEventListener("error",(function(t){webkit.messageHandlers.logError.postMessage({message:t.message,filename:t.filename,line:t.lineno})}),!1),window.addEventListener("load",(function(){window.addEventListener("orientationchange",(function(){l(),f()})),l()}),!1);var t,e,o=0,r=0,i=!1,s=0;function l(){s=0===window.orientation||180==window.orientation?screen.width:screen.height}function a(){return"readium-scroll-on"===document.documentElement.style.getPropertyValue("--USER__scroll").toString().trim()}function c(t){var e=window.scrollX,n=window.innerWidth;return document.scrollingElement.scrollLeft=t,Math.abs(e-t)/n>.01}function d(t){var e=t+1;return e-e%s}function f(){if(!a()){var t=d(window.scrollX+1);document.scrollingElement.scrollLeft=t}}function h(){var t=Array.prototype.slice.call(arguments).join(" ");webkit.messageHandlers.log.postMessage(t)}function u(t,e,n,o){const r=new Range;if(r.setStart(t,e),r.setEnd(n,o),!r.collapsed)return r;E(">>> createOrderedRange COLLAPSED ... RANGE REVERSE?");const i=new Range;if(i.setStart(n,o),i.setEnd(t,e),!i.collapsed)return E(">>> createOrderedRange RANGE REVERSE OK."),r;E(">>> createOrderedRange RANGE REVERSE ALSO COLLAPSED?!")}function g(t){return{cssSelector:t.startContainerElementCssSelector,domRange:{start:{cssSelector:t.startContainerElementCssSelector,textNodeIndex:t.startContainerChildTextNodeIndex,offset:t.startOffset},end:{cssSelector:t.endContainerElementCssSelector,textNodeIndex:t.endContainerChildTextNodeIndex,offset:t.endOffset}}}}function m(t){return t.nodeType!==Node.ELEMENT_NODE?t.localName&&t.localName.toLowerCase()||t.nodeName.toLowerCase():function(t,e){if(t.nodeType!==Node.ELEMENT_NODE)return"";const n=[];let o=t;for(;o;){const e=p(o,!0,o===t);if(!e)break;if(n.push(e.value),e.optimized)break;o=o.parentNode}return n.reverse(),n.join(" > ")}(t)}function p(t,e,n){function o(t){return"#"+r(t)}function r(t){if(/^-?[a-zA-Z_][a-zA-Z0-9_-]*$/.test(t))return t;const e=/^(?:[0-9]|-[0-9-]?)/.test(t),n=t.length-1;return t.replace(/./g,(function(t,o){return e&&0===o||!function(t){return!!/[a-zA-Z0-9_-]/.test(t)||t.charCodeAt(0)>=160}(t)?function(t,e){return"\\"+function(t){let e=t.charCodeAt(0).toString(16);return 1===e.length&&(e="0"+e),e}(t)+(e?"":" ")}(t,o===n):t}))}function i(t){const e=t.getAttribute("class");return e?e.split(/\s+/g).filter(Boolean).map((t=>"$"+t)):[]}if(t.nodeType!==Node.ELEMENT_NODE)return;const s=t.localName&&t.localName.toLowerCase()||t.nodeName.toLowerCase(),l=t,a=l.getAttribute("id");if(e){if(a)return{optimized:!0,value:o(a)};if("body"===s||"head"===s||"html"===s)return{optimized:!0,value:s}}const c=s;if(a)return{optimized:!0,value:c+o(a)};const d=t.parentNode;if(!d||d.nodeType===Node.DOCUMENT_NODE)return{optimized:!0,value:c};const f=i(l),h=[];f.forEach((t=>{h.indexOf(t)<0&&h.push(t)}));let u=!1,g=!1,m=-1,p=-1;const E=d.children;for(let e=0;(-1===m||!g)&&e<E.length;++e){const n=E[e];if(n.nodeType!==Node.ELEMENT_NODE)continue;if(p+=1,n===t){m=p;continue}if(g)continue;if((n.localName&&n.localName.toLowerCase()||n.nodeName.toLowerCase())!==c)continue;u=!0;const o=[];h.forEach((t=>{o.push(t)}));let r=o.length;if(0===r){g=!0;continue}const s=i(n),l=[];s.forEach((t=>{l.indexOf(t)<0&&l.push(t)}));for(const t of l){const e=o.indexOf(t);if(!(e<0||(o.splice(e,1),--r))){g=!0;break}}}let w=c;if(n&&"input"===c&&l.getAttribute("type")&&!l.getAttribute("id")&&!l.getAttribute("class")&&(w+='[type="'+l.getAttribute("type")+'"]'),g)w+=":nth-child("+(m+1)+")";else if(u)for(const t of h)w+="."+r(t.substr(1));return{optimized:!1,value:w}}function E(){h.apply(null,arguments)}function w(t,e){let n=t.getClientRects();const o=[];for(const t of n)o.push({bottom:t.bottom,height:t.height,left:t.left,right:t.right,top:t.top,width:t.width});const r=v(function(t,e){const n=new Set(t);for(const e of t)if(e.width>1&&e.height>1){for(const o of t)if(e!==o&&n.has(o)&&T(o,e,1)){R(),n.delete(e);break}}else R(),n.delete(e);return Array.from(n)}(N(o,1,e)));for(let t=r.length-1;t>=0;t--){const e=r[t];if(!(e.width*e.height>4)){if(!(r.length>1)){R();break}R(),r.splice(t,1)}}return R((o.length,r.length)),r}function N(t,e,n){for(let o=0;o<t.length;o++)for(let r=o+1;r<t.length;r++){const i=t[o],s=t[r];if(i===s){R();continue}const l=O(i.top,s.top,e)&&O(i.bottom,s.bottom,e),a=O(i.left,s.left,e)&&O(i.right,s.right,e),c=!n;if((a&&c||l&&!a)&&b(i,s,e)){R();const o=t.filter((t=>t!==i&&t!==s)),r=C(i,s);return o.push(r),N(o,e,n)}}return t}function C(t,e){const n=Math.min(t.left,e.left),o=Math.max(t.right,e.right),r=Math.min(t.top,e.top),i=Math.max(t.bottom,e.bottom);return{bottom:i,height:i-r,left:n,right:o,top:r,width:o-n}}function T(t,e,n){return x(t,e.left,e.top,n)&&x(t,e.right,e.top,n)&&x(t,e.left,e.bottom,n)&&x(t,e.right,e.bottom,n)}function x(t,e,n,o){return(t.left<e||O(t.left,e,o))&&(t.right>e||O(t.right,e,o))&&(t.top<n||O(t.top,n,o))&&(t.bottom>n||O(t.bottom,n,o))}function v(t){for(let e=0;e<t.length;e++)for(let n=e+1;n<t.length;n++){const o=t[e],r=t[n];if(o!==r){if(b(o,r,-1)){let e,n,i=[];const s=y(o,r);if(1===s.length)i=s,e=o,n=r;else{const t=y(r,o);s.length<t.length?(i=s,e=o,n=r):(i=t,e=r,n=o)}R(i.length);const l=t.filter((t=>t!==e));return Array.prototype.push.apply(l,i),v(l)}}else R()}return t}function y(t,e){const n=function(t,e){const n=Math.max(t.left,e.left),o=Math.min(t.right,e.right),r=Math.max(t.top,e.top),i=Math.min(t.bottom,e.bottom);return{bottom:i,height:Math.max(0,i-r),left:n,right:o,top:r,width:Math.max(0,o-n)}}(e,t);if(0===n.height||0===n.width)return[t];const o=[];{const e={bottom:t.bottom,height:0,left:t.left,right:n.left,top:t.top,width:0};e.width=e.right-e.left,e.height=e.bottom-e.top,0!==e.height&&0!==e.width&&o.push(e)}{const e={bottom:n.top,height:0,left:n.left,right:n.right,top:t.top,width:0};e.width=e.right-e.left,e.height=e.bottom-e.top,0!==e.height&&0!==e.width&&o.push(e)}{const e={bottom:t.bottom,height:0,left:n.left,right:n.right,top:n.bottom,width:0};e.width=e.right-e.left,e.height=e.bottom-e.top,0!==e.height&&0!==e.width&&o.push(e)}{const e={bottom:t.bottom,height:0,left:n.right,right:t.right,top:t.top,width:0};e.width=e.right-e.left,e.height=e.bottom-e.top,0!==e.height&&0!==e.width&&o.push(e)}return o}function b(t,e,n){return(t.left<e.right||n>=0&&O(t.left,e.right,n))&&(e.left<t.right||n>=0&&O(e.left,t.right,n))&&(t.top<e.bottom||n>=0&&O(t.top,e.bottom,n))&&(e.top<t.bottom||n>=0&&O(e.top,t.bottom,n))}function O(t,e,n){return Math.abs(t-e)<=n}function R(){}window.addEventListener("scroll",(function(t){r=window.scrollY/document.scrollingElement.scrollHeight,o=Math.abs(window.scrollX/document.scrollingElement.scrollWidth),0!==document.scrollingElement.scrollWidth&&0!==document.scrollingElement.scrollHeight&&(i||window.requestAnimationFrame((function(){var t;t=(a()?r:o).toString(),webkit.messageHandlers.progressionChanged.postMessage(t),i=!1})),i=!0)})),document.addEventListener("selectionchange",(50,t=function(){var t={},e=document.getSelection();if(e&&e.rangeCount>0){var n=e.getRangeAt(0).getBoundingClientRect();t.text=e.toString().trim(),t.frame={x:n.left,y:n.top,width:n.width,height:n.height}}webkit.messageHandlers.selectionChanged.postMessage(t)},function(){var n=this,o=arguments;function r(){t.apply(n,o),e=null}clearTimeout(e),e=setTimeout(r,50)}));const S=[];let A;const L={blue:100,green:50,red:230};function M(t){let e=-1,n=window.document;S.find(((n,o)=>(e=o,n.id===t)))&&e>=0&&e<S.length&&S.splice(e,1);const o=n.getElementById(t);o&&o.remove()}function I(t,e){if(!t)return;const n=1/(window.READIUM2&&window.READIUM2.isFixedLayout?window.READIUM2.fxlViewportScale:1),o=document.scrollingElement,r=!("readium-scroll-on"===document.documentElement.style.getPropertyValue("--USER__scroll").toString().trim()),i=function(t){const e=window.document;return A||(A=e.createElement("div"),A.setAttribute("id","R2_ID_HIGHLIGHTS_CONTAINER"),A.style.setProperty("pointer-events","none"),e.body.append(A)),A}(),s=document.createElement("div");s.setAttribute("id",e.id),s.setAttribute("class","R2_CLASS_HIGHLIGHT_CONTAINER"),s.style.setProperty("pointer-events","none"),e.pointerInteraction&&s.setAttribute("data-click","1");const l=document.body.getBoundingClientRect(),a=w(t,!1);let c,d;c=r?-o.scrollLeft:l.left,d=r?-o.scrollTop:l.top;for(const t of a){const o=document.createElement("div");o.setAttribute("class","R2_CLASS_HIGHLIGHT_AREA"),o.setAttribute("style",`border-radius: 3px !important; background-color: rgba(${e.color.red}, ${e.color.green}, ${e.color.blue}, 0.3) !important; `),o.style.setProperty("pointer-events","none"),o.style.position=r?"absolute":"fixed",o.scale=n,o.rect={height:t.height,left:t.left-c,top:t.top-d,width:t.width},o.style.width=o.rect.width*n+"px",o.style.height=o.rect.height*n+"px",o.style.left=o.rect.left*n+"px",o.style.top=o.rect.top*n+"px",s.append(o)}const f=document.createElement("div");f.setAttribute("class","R2_CLASS_HIGHLIGHT_BOUNDING_AREA"),f.style.setProperty("pointer-events","none"),f.style.position=r?"fixed":"absolute",f.scale=n;const h=t.getBoundingClientRect();return f.rect={height:h.height,left:h.left-c,top:h.top-d,width:h.width},f.style.width=f.rect.width*n+"px",f.style.height=f.rect.height*n+"px",f.style.left=f.rect.left*n+"px",f.style.top=f.rect.top*n+"px",s.append(f),i.append(s),s}var _=n(89);function D(t,e,n){let o=0,r=[];for(;-1!==o;)o=t.indexOf(e,o),-1!==o&&(r.push({start:o,end:o+e.length,errors:0}),o+=1);return r.length>0?r:(0,_.Z)(t,e,n)}function H(t,e){return 0===e.length?0:1-D(t,e,e.length)[0].errors/e.length}function P(t){switch(t.nodeType){case Node.ELEMENT_NODE:case Node.TEXT_NODE:return t.textContent.length;default:return 0}}function k(t){let e=t.previousSibling,n=0;for(;e;)n+=P(e),e=e.previousSibling;return n}function $(t,...e){let n=e.shift();const o=t.ownerDocument.createNodeIterator(t,NodeFilter.SHOW_TEXT),r=[];let i,s=o.nextNode(),l=0;for(;void 0!==n&&s;)i=s,l+i.data.length>n?(r.push({node:i,offset:n-l}),n=e.shift()):(s=o.nextNode(),l+=i.data.length);for(;void 0!==n&&i&&l===n;)r.push({node:i,offset:i.data.length}),n=e.shift();if(void 0!==n)throw new RangeError("Offset exceeds text length");return r}class X{constructor(t,e){if(e<0)throw new Error("Offset is invalid");this.element=t,this.offset=e}relativeTo(t){if(!t.contains(this.element))throw new Error("Parent is not an ancestor of current element");let e=this.element,n=this.offset;for(;e!==t;)n+=k(e),e=e.parentElement;return new X(e,n)}resolve(t={}){try{return $(this.element,this.offset)[0]}catch(e){if(0===this.offset&&void 0!==t.direction){const n=document.createTreeWalker(this.element.getRootNode(),NodeFilter.SHOW_TEXT);n.currentNode=this.element;const o=1===t.direction,r=o?n.nextNode():n.previousNode();if(!r)throw e;return{node:r,offset:o?0:r.data.length}}throw e}}static fromCharOffset(t,e){switch(t.nodeType){case Node.TEXT_NODE:return X.fromPoint(t,e);case Node.ELEMENT_NODE:return new X(t,e);default:throw new Error("Node is not an element or text node")}}static fromPoint(t,e){switch(t.nodeType){case Node.TEXT_NODE:{if(e<0||e>t.data.length)throw new Error("Text node offset is out of range");if(!t.parentElement)throw new Error("Text node has no parent");const n=k(t)+e;return new X(t.parentElement,n)}case Node.ELEMENT_NODE:{if(e<0||e>t.childNodes.length)throw new Error("Child node offset is out of range");let n=0;for(let o=0;o<e;o++)n+=P(t.childNodes[o]);return new X(t,n)}default:throw new Error("Point is not in an element or text node")}}}class G{constructor(t,e){this.start=t,this.end=e}relativeTo(t){return new G(this.start.relativeTo(t),this.end.relativeTo(t))}toRange(){let t,e;this.start.element===this.end.element&&this.start.offset<=this.end.offset?[t,e]=$(this.start.element,this.start.offset,this.end.offset):(t=this.start.resolve({direction:1}),e=this.end.resolve({direction:2}));const n=new Range;return n.setStart(t.node,t.offset),n.setEnd(e.node,e.offset),n}static fromRange(t){const e=X.fromPoint(t.startContainer,t.startOffset),n=X.fromPoint(t.endContainer,t.endOffset);return new G(e,n)}static fromOffsets(t,e,n){return new G(new X(t,e),new X(t,n))}}class U{constructor(t,e,n){this.root=t,this.start=e,this.end=n}static fromRange(t,e){const n=G.fromRange(e).relativeTo(t);return new U(t,n.start.offset,n.end.offset)}static fromSelector(t,e){return new U(t,e.start,e.end)}toSelector(){return{type:"TextPositionSelector",start:this.start,end:this.end}}toRange(){return G.fromOffsets(this.root,this.start,this.end).toRange()}}class W{constructor(t,e,n={}){this.root=t,this.exact=e,this.context=n}static fromRange(t,e){const n=t.textContent,o=G.fromRange(e).relativeTo(t),r=o.start.offset,i=o.end.offset;return new W(t,n.slice(r,i),{prefix:n.slice(Math.max(0,r-32),r),suffix:n.slice(i,Math.min(n.length,i+32))})}static fromSelector(t,e){const{prefix:n,suffix:o}=e;return new W(t,e.exact,{prefix:n,suffix:o})}toSelector(){return{type:"TextQuoteSelector",exact:this.exact,prefix:this.context.prefix,suffix:this.context.suffix}}toRange(t={}){return this.toPositionAnchor(t).toRange()}toPositionAnchor(t={}){const e=function(t,e,n={}){if(0===e.length)return null;const o=Math.min(256,e.length/2),r=D(t,e,o);if(0===r.length)return null;const i=o=>{const r=1-o.errors/e.length,i=n.prefix?H(t.slice(o.start-n.prefix.length,o.start),n.prefix):1,s=n.suffix?H(t.slice(o.end,o.end+n.suffix.length),n.suffix):1;let l=1;return"number"==typeof n.hint&&(l=1-Math.abs(o.start-n.hint)/t.length),(50*r+20*i+20*s+2*l)/92},s=r.map((t=>({start:t.start,end:t.end,score:i(t)})));return s.sort(((t,e)=>e.score-t.score)),s[0]}(this.root.textContent,this.exact,{...this.context,hint:t.hint});if(!e)throw new Error("Quote not found");return new U(this.root,e.start,e.end)}}window.readium={scrollToId:function(t){var e=document.getElementById(t);if(!e)return!1;if(e.scrollIntoView(),!a()){var n=window.scrollX,o=window.innerWidth;document.scrollingElement.scrollLeft=d(n+o/2)}return!0},scrollToPosition:function(t,e){if(console.log("ScrollToPosition"),t<0||t>1)console.log("InvalidPosition");else if(a()){var n=document.scrollingElement.scrollHeight*t;document.scrollingElement.scrollTop=n}else n=document.scrollingElement.scrollWidth*t*("rtl"==e?-1:1),document.scrollingElement.scrollLeft=d(n)},scrollToText:function(t){function e(t){this.selection=t,this.markedRanges=[]}function n(t){return t.replace(/\s+/g,"")}e.prototype.clear=function(){this.selection.removeAllRanges()},e.prototype.mark=function(){this.markedRanges=[];for(var t=0;t<this.selection.rangeCount;t++)this.markedRanges.push(this.selection.getRangeAt(t))},e.prototype.reset=function(){this.clear();for(var t=0;t<this.markedRanges.length;t++)this.selection.addRange(this.markedRanges[t])},e.prototype.toString=function(){return this.selection.toString()},e.prototype.adjust=function(t,e){for(var n=0;n<=Math.abs(t);n++){var o=t>=0?"forward":"backward";this.selection.modify("move",o,"character")}for(n=0;n<=e;n++)this.selection.modify("extend","forward","character")},e.prototype.isEmpty=function(){return this.selection.isCollapsed},e.prototype.getFirstRange=function(){return this.selection.getRangeAt(0)};var o=t.highlight,r=t.before||"",i=r+o+(t.after||""),s=n(i);if(!o||!s)return!1;var l=new e(window.getSelection());l.clear();for(var c,d,h=!1;window.find(t.highlight,!0)&&!l.isEmpty();){l.mark(),l.adjust(-r.length,i.length);var u=n(l.toString());if(l.reset(),""!==u&&(s.includes(u)||u.includes(s))){h=!0;break}}return!(!h||l.isEmpty()||(c=l.getFirstRange(),d=c.getBoundingClientRect(),a()?document.scrollingElement.scrollTop=d.top+window.scrollY-window.innerHeight/2:(document.scrollingElement.scrollLeft=d.left+window.scrollX,f()),l.clear(),0))},scrollLeft:function(t){var e="rtl"==t,n=document.scrollingElement.scrollWidth,o=window.innerWidth,r=window.scrollX-o,i=e?-(n-o):0;return c(Math.max(r,i))},scrollRight:function(t){var e="rtl"==t,n=document.scrollingElement.scrollWidth,o=window.innerWidth,r=window.scrollX+o,i=e?0:n-o;return c(Math.min(r,i))},setProperty:function(t,e){document.documentElement.style.setProperty(t,e)},removeProperty:function(t){document.documentElement.style.removeProperty(t)},getSelectionRect:function(){try{let t=window.getSelection();if(!t)return;const e=t.getRangeAt(0).getBoundingClientRect();return{screenWidth:window.outerWidth,screenHeight:window.outerHeight,left:e.left,width:e.width,top:e.top,height:e.height}}catch(t){return function(t){webkit.messageHandlers.logError.postMessage({message:t.message})}(t),null}},getCurrentSelectionInfo:function(){const t=window.getSelection();if(!t)return;if(t.isCollapsed)return void E("^^^ SELECTION COLLAPSED.");const e=t.toString();if(0===e.trim().replace(/\n/g," ").replace(/\s\s+/g," ").length)return void E("^^^ SELECTION TEXT EMPTY.");if(!t.anchorNode||!t.focusNode)return;const n=1===t.rangeCount?t.getRangeAt(0):u(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset);if(!n||n.collapsed)return void E("$$$$$$$$$$$$$$$$$ CANNOT GET NON-COLLAPSED SELECTION RANGE?!");const o=function(t,e){const n=t.startContainer.nodeType===Node.ELEMENT_NODE,o=n?t.startContainer:t.startContainer.parentNode&&t.startContainer.parentNode.nodeType===Node.ELEMENT_NODE?t.startContainer.parentNode:void 0;if(!o)return;const r=n?-1:Array.from(o.childNodes).indexOf(t.startContainer);if(r<-1)return;const i=e(o),s=t.endContainer.nodeType===Node.ELEMENT_NODE,l=s?t.endContainer:t.endContainer.parentNode&&t.endContainer.parentNode.nodeType===Node.ELEMENT_NODE?t.endContainer.parentNode:void 0;if(!l)return;const a=s?-1:Array.from(l.childNodes).indexOf(t.endContainer);if(a<-1)return;const c=e(l),d=function(t,e){if(t.nodeType===Node.ELEMENT_NODE&&t===e)return t;if(t.nodeType===Node.ELEMENT_NODE&&t.contains(e))return t;if(e.nodeType===Node.ELEMENT_NODE&&e.contains(t))return e;const n=[];let o=t.parentNode;for(;o&&o.nodeType===Node.ELEMENT_NODE;)n.push(o),o=o.parentNode;const r=[];for(o=e.parentNode;o&&o.nodeType===Node.ELEMENT_NODE;)r.push(o),o=o.parentNode;let i=n.find((t=>r.indexOf(t)>=0));return i||(i=r.find((t=>n.indexOf(t)>=0))),i}(t.startContainer,t.endContainer);if(d){if(t.commonAncestorContainer){const n=t.commonAncestorContainer.nodeType===Node.ELEMENT_NODE?t.commonAncestorContainer:t.commonAncestorContainer.parentNode;n&&n.nodeType===Node.ELEMENT_NODE&&d!==n&&(E(">>>>>> COMMON ANCESTOR CONTAINER DIFF??!"),E(e(d)),E(e(n)))}return{endContainerChildTextNodeIndex:a,endContainerElementCssSelector:c,endOffset:t.endOffset,startContainerChildTextNodeIndex:r,startContainerElementCssSelector:i,startOffset:t.startOffset}}E("^^^ NO RANGE COMMON ANCESTOR?!")}(n,m);if(o)return{locations:g(o),text:{highlight:e}};E("^^^ SELECTION RANGE INFO FAIL?!")},createHighlight:function(t,e,n){const o=function(t){const e=t.locations.domRange,n=e.start,o=e.end;return{endContainerChildTextNodeIndex:o.textNodeIndex,endContainerElementCssSelector:o.cssSelector,endOffset:o.offset,startContainerChildTextNodeIndex:n.textNodeIndex,startContainerElementCssSelector:n.cssSelector,startOffset:n.offset}}(t);let r="R2_HIGHLIGHT_"+Date.now();M(r);const i={color:e||L,id:r,pointerInteraction:n,rangeInfo:o};return S.push(i),function(t){I(function(t,e){const n=t.querySelector(e.startContainerElementCssSelector);if(!n)return void E("^^^ convertRangeInfo NO START ELEMENT CSS SELECTOR?!");let o=n;if(e.startContainerChildTextNodeIndex>=0){if(e.startContainerChildTextNodeIndex>=n.childNodes.length)return void E("^^^ convertRangeInfo rangeInfo.startContainerChildTextNodeIndex >= startElement.childNodes.length?!");if(o=n.childNodes[e.startContainerChildTextNodeIndex],o.nodeType!==Node.TEXT_NODE)return void E("^^^ convertRangeInfo startContainer.nodeType !== Node.TEXT_NODE?!")}const r=t.querySelector(e.endContainerElementCssSelector);if(!r)return void E("^^^ convertRangeInfo NO END ELEMENT CSS SELECTOR?!");let i=r;if(e.endContainerChildTextNodeIndex>=0){if(e.endContainerChildTextNodeIndex>=r.childNodes.length)return void E("^^^ convertRangeInfo rangeInfo.endContainerChildTextNodeIndex >= endElement.childNodes.length?!");if(i=r.childNodes[e.endContainerChildTextNodeIndex],i.nodeType!==Node.TEXT_NODE)return void E("^^^ convertRangeInfo endContainer.nodeType !== Node.TEXT_NODE?!")}return u(o,e.startOffset,i,e.endOffset)}(document,t.rangeInfo),t)}(i),i},createHighlightRange:function(t){let e="R2_HIGHLIGHT_"+Date.now();M(e);const n={color:L,id:e,pointerInteraction:!0,rangeInfo:null};return S.push(n),I(t,n),n},TextQuoteAnchor:W},window.addEventListener("load",(function(){window.requestAnimationFrame((function(){webkit.messageHandlers.spreadLoaded.postMessage({})}));let t=document.createElement("meta");t.setAttribute("name","viewport"),t.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no"),document.head.appendChild(t)})),document.addEventListener("DOMContentLoaded",(function(){function t(t){var e=document.createElement("link");return e.setAttribute("rel","stylesheet"),e.setAttribute("type","text/css"),e.setAttribute("href","${readiumCSSBaseURL}"+t+".css"),e}var e=document.getElementsByTagName("head")[0];e.appendChild(t("ReadiumCSS-after")),e.insertBefore(t("ReadiumCSS-before"),e.children[0])}))})()})();
//# sourceMappingURL=readium-reflowable.js.map