(()=>{var t={581:()=>{function t(t){window.getSelection().isCollapsed&&webkit.messageHandlers.tap.postMessage({defaultPrevented:t.defaultPrevented,screenX:t.screenX,screenY:t.screenY,clientX:t.clientX,clientY:t.clientY,targetElement:t.target.outerHTML,interactiveElement:e(t.target)})}function e(t){return-1!==["a","audio","button","canvas","details","input","label","option","select","submit","textarea","video"].indexOf(t.nodeName.toLowerCase())||t.hasAttribute("contenteditable")&&"false"!=t.getAttribute("contenteditable").toLowerCase()?t.outerHTML:t.parentElement?e(t.parentElement):null}window.addEventListener("DOMContentLoaded",(function(e){document.body.style.cursor="pointer",document.addEventListener("click",t,!1)}))}},e={};function n(o){var r=e[o];if(void 0!==r)return r.exports;var i=e[o]={exports:{}};return t[o](i,i.exports,n),i.exports}(()=>{"use strict";n(581),window.addEventListener("error",(function(t){webkit.messageHandlers.logError.postMessage({message:t.message,filename:t.filename,line:t.lineno})}),!1),window.addEventListener("load",(function(){window.addEventListener("orientationchange",(function(){l(),f()})),l()}),!1);var t,e,o=0,r=0,i=!1,s=0;function l(){s=0===window.orientation||180==window.orientation?screen.width:screen.height}function d(){return"readium-scroll-on"===document.documentElement.style.getPropertyValue("--USER__scroll").toString().trim()}function c(t){var e=window.scrollX,n=window.innerWidth;return document.scrollingElement.scrollLeft=t,Math.abs(e-t)/n>.01}function a(t){var e=t+1;return e-e%s}function f(){if(!d()){var t=a(window.scrollX+1);document.scrollingElement.scrollLeft=t}}function u(){var t=Array.prototype.slice.call(arguments).join(" ");webkit.messageHandlers.log.postMessage(t)}function h(t,e,n,o){const r=new Range;if(r.setStart(t,e),r.setEnd(n,o),!r.collapsed)return r;E(">>> createOrderedRange COLLAPSED ... RANGE REVERSE?");const i=new Range;if(i.setStart(n,o),i.setEnd(t,e),!i.collapsed)return E(">>> createOrderedRange RANGE REVERSE OK."),r;E(">>> createOrderedRange RANGE REVERSE ALSO COLLAPSED?!")}function g(t){return{cssSelector:t.startContainerElementCssSelector,domRange:{start:{cssSelector:t.startContainerElementCssSelector,textNodeIndex:t.startContainerChildTextNodeIndex,offset:t.startOffset},end:{cssSelector:t.endContainerElementCssSelector,textNodeIndex:t.endContainerChildTextNodeIndex,offset:t.endOffset}}}}function m(t){return t.nodeType!==Node.ELEMENT_NODE?t.localName&&t.localName.toLowerCase()||t.nodeName.toLowerCase():function(t,e){if(t.nodeType!==Node.ELEMENT_NODE)return"";const n=[];let o=t;for(;o;){const e=p(o,!0,o===t);if(!e)break;if(n.push(e.value),e.optimized)break;o=o.parentNode}return n.reverse(),n.join(" > ")}(t)}function p(t,e,n){function o(t){return"#"+r(t)}function r(t){if(/^-?[a-zA-Z_][a-zA-Z0-9_-]*$/.test(t))return t;const e=/^(?:[0-9]|-[0-9-]?)/.test(t),n=t.length-1;return t.replace(/./g,(function(t,o){return e&&0===o||!function(t){return!!/[a-zA-Z0-9_-]/.test(t)||t.charCodeAt(0)>=160}(t)?function(t,e){return"\\"+function(t){let e=t.charCodeAt(0).toString(16);return 1===e.length&&(e="0"+e),e}(t)+(e?"":" ")}(t,o===n):t}))}function i(t){const e=t.getAttribute("class");return e?e.split(/\s+/g).filter(Boolean).map((t=>"$"+t)):[]}if(t.nodeType!==Node.ELEMENT_NODE)return;const s=t.localName&&t.localName.toLowerCase()||t.nodeName.toLowerCase(),l=t,d=l.getAttribute("id");if(e){if(d)return{optimized:!0,value:o(d)};if("body"===s||"head"===s||"html"===s)return{optimized:!0,value:s}}const c=s;if(d)return{optimized:!0,value:c+o(d)};const a=t.parentNode;if(!a||a.nodeType===Node.DOCUMENT_NODE)return{optimized:!0,value:c};const f=i(l),u=[];f.forEach((t=>{u.indexOf(t)<0&&u.push(t)}));let h=!1,g=!1,m=-1,p=-1;const E=a.children;for(let e=0;(-1===m||!g)&&e<E.length;++e){const n=E[e];if(n.nodeType!==Node.ELEMENT_NODE)continue;if(p+=1,n===t){m=p;continue}if(g)continue;if((n.localName&&n.localName.toLowerCase()||n.nodeName.toLowerCase())!==c)continue;h=!0;const o=[];u.forEach((t=>{o.push(t)}));let r=o.length;if(0===r){g=!0;continue}const s=i(n),l=[];s.forEach((t=>{l.indexOf(t)<0&&l.push(t)}));for(const t of l){const e=o.indexOf(t);if(!(e<0||(o.splice(e,1),--r))){g=!0;break}}}let N=c;if(n&&"input"===c&&l.getAttribute("type")&&!l.getAttribute("id")&&!l.getAttribute("class")&&(N+='[type="'+l.getAttribute("type")+'"]'),g)N+=":nth-child("+(m+1)+")";else if(h)for(const t of u)N+="."+r(t.substr(1));return{optimized:!1,value:N}}function E(){u.apply(null,arguments)}function N(t,e){let n=t.getClientRects();const o=[];for(const t of n)o.push({bottom:t.bottom,height:t.height,left:t.left,right:t.right,top:t.top,width:t.width});const r=b(function(t,e){const n=new Set(t);for(const e of t)if(e.width>1&&e.height>1){for(const o of t)if(e!==o&&n.has(o)&&T(o,e,1)){S(),n.delete(e);break}}else S(),n.delete(e);return Array.from(n)}(w(o,1,e)));for(let t=r.length-1;t>=0;t--){const e=r[t];if(!(e.width*e.height>4)){if(!(r.length>1)){S();break}S(),r.splice(t,1)}}return S((o.length,r.length)),r}function w(t,e,n){for(let o=0;o<t.length;o++)for(let r=o+1;r<t.length;r++){const i=t[o],s=t[r];if(i===s){S();continue}const l=O(i.top,s.top,e)&&O(i.bottom,s.bottom,e),d=O(i.left,s.left,e)&&O(i.right,s.right,e),c=!n;if((d&&c||l&&!d)&&x(i,s,e)){S();const o=t.filter((t=>t!==i&&t!==s)),r=C(i,s);return o.push(r),w(o,e,n)}}return t}function C(t,e){const n=Math.min(t.left,e.left),o=Math.max(t.right,e.right),r=Math.min(t.top,e.top),i=Math.max(t.bottom,e.bottom);return{bottom:i,height:i-r,left:n,right:o,top:r,width:o-n}}function T(t,e,n){return y(t,e.left,e.top,n)&&y(t,e.right,e.top,n)&&y(t,e.left,e.bottom,n)&&y(t,e.right,e.bottom,n)}function y(t,e,n,o){return(t.left<e||O(t.left,e,o))&&(t.right>e||O(t.right,e,o))&&(t.top<n||O(t.top,n,o))&&(t.bottom>n||O(t.bottom,n,o))}function b(t){for(let e=0;e<t.length;e++)for(let n=e+1;n<t.length;n++){const o=t[e],r=t[n];if(o!==r){if(x(o,r,-1)){let e,n,i=[];const s=v(o,r);if(1===s.length)i=s,e=o,n=r;else{const t=v(r,o);s.length<t.length?(i=s,e=o,n=r):(i=t,e=r,n=o)}S(i.length);const l=t.filter((t=>t!==e));return Array.prototype.push.apply(l,i),b(l)}}else S()}return t}function v(t,e){const n=function(t,e){const n=Math.max(t.left,e.left),o=Math.min(t.right,e.right),r=Math.max(t.top,e.top),i=Math.min(t.bottom,e.bottom);return{bottom:i,height:Math.max(0,i-r),left:n,right:o,top:r,width:Math.max(0,o-n)}}(e,t);if(0===n.height||0===n.width)return[t];const o=[];{const e={bottom:t.bottom,height:0,left:t.left,right:n.left,top:t.top,width:0};e.width=e.right-e.left,e.height=e.bottom-e.top,0!==e.height&&0!==e.width&&o.push(e)}{const e={bottom:n.top,height:0,left:n.left,right:n.right,top:t.top,width:0};e.width=e.right-e.left,e.height=e.bottom-e.top,0!==e.height&&0!==e.width&&o.push(e)}{const e={bottom:t.bottom,height:0,left:n.left,right:n.right,top:n.bottom,width:0};e.width=e.right-e.left,e.height=e.bottom-e.top,0!==e.height&&0!==e.width&&o.push(e)}{const e={bottom:t.bottom,height:0,left:n.right,right:t.right,top:t.top,width:0};e.width=e.right-e.left,e.height=e.bottom-e.top,0!==e.height&&0!==e.width&&o.push(e)}return o}function x(t,e,n){return(t.left<e.right||n>=0&&O(t.left,e.right,n))&&(e.left<t.right||n>=0&&O(e.left,t.right,n))&&(t.top<e.bottom||n>=0&&O(t.top,e.bottom,n))&&(e.top<t.bottom||n>=0&&O(e.top,t.bottom,n))}function O(t,e,n){return Math.abs(t-e)<=n}function S(){}window.addEventListener("scroll",(function(t){r=window.scrollY/document.scrollingElement.scrollHeight,o=Math.abs(window.scrollX/document.scrollingElement.scrollWidth),0!==document.scrollingElement.scrollWidth&&0!==document.scrollingElement.scrollHeight&&(i||window.requestAnimationFrame((function(){var t;t=(d()?r:o).toString(),webkit.messageHandlers.progressionChanged.postMessage(t),i=!1})),i=!0)})),document.addEventListener("selectionchange",(50,t=function(){var t={},e=document.getSelection();if(e&&e.rangeCount>0){var n=e.getRangeAt(0).getBoundingClientRect();t.text=e.toString().trim(),t.frame={x:n.left,y:n.top,width:n.width,height:n.height}}webkit.messageHandlers.selectionChanged.postMessage(t)},function(){var n=this,o=arguments;function r(){t.apply(n,o),e=null}clearTimeout(e),e=setTimeout(r,50)}));const L="R2_ID_HIGHLIGHTS_CONTAINER",A="R2_CLASS_HIGHLIGHT_AREA",R=[];let I;const M={blue:100,green:50,red:230};function _(){return"readium-scroll-on"===document.documentElement.style.getPropertyValue("--USER__scroll").toString().trim()}window.readium={scrollToId:function(t){var e=document.getElementById(t);if(!e)return!1;if(e.scrollIntoView(),!d()){var n=window.scrollX,o=window.innerWidth;document.scrollingElement.scrollLeft=a(n+o/2)}return!0},scrollToPosition:function(t,e){if(console.log("ScrollToPosition"),t<0||t>1)console.log("InvalidPosition");else if(d()){var n=document.scrollingElement.scrollHeight*t;document.scrollingElement.scrollTop=n}else n=document.scrollingElement.scrollWidth*t*("rtl"==e?-1:1),document.scrollingElement.scrollLeft=a(n)},scrollToText:function(t){function e(t){this.selection=t,this.markedRanges=[]}function n(t){return t.replace(/\s+/g,"")}e.prototype.clear=function(){this.selection.removeAllRanges()},e.prototype.mark=function(){this.markedRanges=[];for(var t=0;t<this.selection.rangeCount;t++)this.markedRanges.push(this.selection.getRangeAt(t))},e.prototype.reset=function(){this.clear();for(var t=0;t<this.markedRanges.length;t++)this.selection.addRange(this.markedRanges[t])},e.prototype.toString=function(){return this.selection.toString()},e.prototype.adjust=function(t,e){for(var n=0;n<=Math.abs(t);n++){var o=t>=0?"forward":"backward";this.selection.modify("move",o,"character")}for(n=0;n<=e;n++)this.selection.modify("extend","forward","character")},e.prototype.isEmpty=function(){return this.selection.isCollapsed},e.prototype.getFirstRange=function(){return this.selection.getRangeAt(0)};var o=t.highlight,r=t.before||"",i=r+o+(t.after||""),s=n(i);if(!o||!s)return!1;var l=new e(window.getSelection());l.clear();for(var c,a,u=!1;window.find(t.highlight,!0)&&!l.isEmpty();){l.mark(),l.adjust(-r.length,i.length);var h=n(l.toString());if(l.reset(),""!==h&&(s.includes(h)||h.includes(s))){u=!0;break}}return!(!u||l.isEmpty()||(c=l.getFirstRange(),a=c.getBoundingClientRect(),d()?document.scrollingElement.scrollTop=a.top+window.scrollY-window.innerHeight/2:(document.scrollingElement.scrollLeft=a.left+window.scrollX,f()),l.clear(),0))},scrollLeft:function(t){var e="rtl"==t,n=document.scrollingElement.scrollWidth,o=window.innerWidth,r=window.scrollX-o,i=e?-(n-o):0;return c(Math.max(r,i))},scrollRight:function(t){var e="rtl"==t,n=document.scrollingElement.scrollWidth,o=window.innerWidth,r=window.scrollX+o,i=e?0:n-o;return c(Math.min(r,i))},setProperty:function(t,e){document.documentElement.style.setProperty(t,e)},removeProperty:function(t){document.documentElement.style.removeProperty(t)},getSelectionRect:function(){try{let t=window.getSelection();if(!t)return;const e=t.getRangeAt(0).getBoundingClientRect();return{screenWidth:window.outerWidth,screenHeight:window.outerHeight,left:e.left,width:e.width,top:e.top,height:e.height}}catch(t){return function(t){webkit.messageHandlers.logError.postMessage({message:t.message})}(t),null}},getCurrentSelectionInfo:function(){const t=window.getSelection();if(!t)return;if(t.isCollapsed)return void E("^^^ SELECTION COLLAPSED.");const e=t.toString();if(0===e.trim().replace(/\n/g," ").replace(/\s\s+/g," ").length)return void E("^^^ SELECTION TEXT EMPTY.");if(!t.anchorNode||!t.focusNode)return;const n=1===t.rangeCount?t.getRangeAt(0):h(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset);if(!n||n.collapsed)return void E("$$$$$$$$$$$$$$$$$ CANNOT GET NON-COLLAPSED SELECTION RANGE?!");const o=function(t,e){const n=t.startContainer.nodeType===Node.ELEMENT_NODE,o=n?t.startContainer:t.startContainer.parentNode&&t.startContainer.parentNode.nodeType===Node.ELEMENT_NODE?t.startContainer.parentNode:void 0;if(!o)return;const r=n?-1:Array.from(o.childNodes).indexOf(t.startContainer);if(r<-1)return;const i=e(o),s=t.endContainer.nodeType===Node.ELEMENT_NODE,l=s?t.endContainer:t.endContainer.parentNode&&t.endContainer.parentNode.nodeType===Node.ELEMENT_NODE?t.endContainer.parentNode:void 0;if(!l)return;const d=s?-1:Array.from(l.childNodes).indexOf(t.endContainer);if(d<-1)return;const c=e(l),a=function(t,e){if(t.nodeType===Node.ELEMENT_NODE&&t===e)return t;if(t.nodeType===Node.ELEMENT_NODE&&t.contains(e))return t;if(e.nodeType===Node.ELEMENT_NODE&&e.contains(t))return e;const n=[];let o=t.parentNode;for(;o&&o.nodeType===Node.ELEMENT_NODE;)n.push(o),o=o.parentNode;const r=[];for(o=e.parentNode;o&&o.nodeType===Node.ELEMENT_NODE;)r.push(o),o=o.parentNode;let i=n.find((t=>r.indexOf(t)>=0));return i||(i=r.find((t=>n.indexOf(t)>=0))),i}(t.startContainer,t.endContainer);if(a){if(t.commonAncestorContainer){const n=t.commonAncestorContainer.nodeType===Node.ELEMENT_NODE?t.commonAncestorContainer:t.commonAncestorContainer.parentNode;n&&n.nodeType===Node.ELEMENT_NODE&&a!==n&&(E(">>>>>> COMMON ANCESTOR CONTAINER DIFF??!"),E(e(a)),E(e(n)))}return{endContainerChildTextNodeIndex:d,endContainerElementCssSelector:c,endOffset:t.endOffset,startContainerChildTextNodeIndex:r,startContainerElementCssSelector:i,startOffset:t.startOffset}}E("^^^ NO RANGE COMMON ANCESTOR?!")}(n,m);if(o)return{locations:g(o),text:{highlight:e}};E("^^^ SELECTION RANGE INFO FAIL?!")},createHighlight:function(t,e,n){return function(t,e,n,o){const r=function(t){const e=t.locations.domRange,n=e.start,o=e.end;return{endContainerChildTextNodeIndex:o.textNodeIndex,endContainerElementCssSelector:o.cssSelector,endOffset:o.offset,startContainerChildTextNodeIndex:n.textNodeIndex,startContainerElementCssSelector:n.cssSelector,startOffset:n.offset}}(t);let i=Date.now();i="R2_HIGHLIGHT_"+i,function(t){let e=-1,n=window.document;R.find(((n,o)=>(e=o,n.id===t)))&&e>=0&&e<R.length&&R.splice(e,1);const o=n.getElementById(t);o&&o.remove()}(i);const s={color:e||M,id:i,pointerInteraction:n,rangeInfo:r};return R.push(s),function(t,e){const n=t.document,o=1/(t.READIUM2&&t.READIUM2.isFixedLayout?t.READIUM2.fxlViewportScale:1),r=n.scrollingElement,i=function(t,e){const n=t.querySelector(e.startContainerElementCssSelector);if(!n)return void E("^^^ convertRangeInfo NO START ELEMENT CSS SELECTOR?!");let o=n;if(e.startContainerChildTextNodeIndex>=0){if(e.startContainerChildTextNodeIndex>=n.childNodes.length)return void E("^^^ convertRangeInfo rangeInfo.startContainerChildTextNodeIndex >= startElement.childNodes.length?!");if(o=n.childNodes[e.startContainerChildTextNodeIndex],o.nodeType!==Node.TEXT_NODE)return void E("^^^ convertRangeInfo startContainer.nodeType !== Node.TEXT_NODE?!")}const r=t.querySelector(e.endContainerElementCssSelector);if(!r)return void E("^^^ convertRangeInfo NO END ELEMENT CSS SELECTOR?!");let i=r;if(e.endContainerChildTextNodeIndex>=0){if(e.endContainerChildTextNodeIndex>=r.childNodes.length)return void E("^^^ convertRangeInfo rangeInfo.endContainerChildTextNodeIndex >= endElement.childNodes.length?!");if(i=r.childNodes[e.endContainerChildTextNodeIndex],i.nodeType!==Node.TEXT_NODE)return void E("^^^ convertRangeInfo endContainer.nodeType !== Node.TEXT_NODE?!")}return h(o,e.startOffset,i,e.endOffset)}(n,e.rangeInfo);if(!i)return;const s=!_(),l=function(t){const e=t.document;return I||(I=e.createElement("div"),I.setAttribute("id",L),I.style.setProperty("pointer-events","none"),e.body.append(I)),I}(t),d=n.createElement("div");d.setAttribute("id",e.id),d.setAttribute("class","R2_CLASS_HIGHLIGHT_CONTAINER"),d.style.setProperty("pointer-events","none"),e.pointerInteraction&&d.setAttribute("data-click","1");const c=n.body.getBoundingClientRect(),a=N(i,false);let f,u,g="";f=s?-r.scrollLeft:c.left,u=s?-r.scrollTop:c.top;for(const t of a){const r=n.createElement("div");r.setAttribute("class",A),r.setAttribute("style",`border-radius: 3px !important; background-color: rgba(${e.color.red}, ${e.color.green}, ${e.color.blue}, 0.3) !important; ${g}`),r.style.setProperty("pointer-events","none"),r.style.position=s?"absolute":"fixed",r.scale=o,r.rect={height:t.height,left:t.left-f,top:t.top-u,width:t.width},r.style.width=r.rect.width*o+"px",r.style.height=r.rect.height*o+"px",r.style.left=r.rect.left*o+"px",r.style.top=r.rect.top*o+"px",d.append(r),false}const m=n.createElement("div");m.setAttribute("class","R2_CLASS_HIGHLIGHT_BOUNDING_AREA"),m.style.setProperty("pointer-events","none"),m.style.position=s?"fixed":"absolute",m.scale=o;const p=i.getBoundingClientRect();m.rect={height:p.height,left:p.left-f,top:p.top-u,width:p.width},m.style.width=m.rect.width*o+"px",m.style.height=m.rect.height*o+"px",m.style.left=m.rect.left*o+"px",m.style.top=m.rect.top*o+"px",d.append(m),l.append(d)}(window,s),s}(t,e,n)}},window.addEventListener("load",(function(){window.requestAnimationFrame((function(){webkit.messageHandlers.spreadLoaded.postMessage({})}));let t=document.createElement("meta");t.setAttribute("name","viewport"),t.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no"),document.head.appendChild(t)})),document.addEventListener("DOMContentLoaded",(function(){function t(t){var e=document.createElement("link");return e.setAttribute("rel","stylesheet"),e.setAttribute("type","text/css"),e.setAttribute("href","${readiumCSSBaseURL}"+t+".css"),e}var e=document.getElementsByTagName("head")[0];e.appendChild(t("ReadiumCSS-after")),e.insertBefore(t("ReadiumCSS-before"),e.children[0])}))})()})();
//# sourceMappingURL=readium-reflowable.js.map