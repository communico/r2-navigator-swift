(()=>{var t={581:()=>{function t(t){window.getSelection().isCollapsed&&webkit.messageHandlers.tap.postMessage({defaultPrevented:t.defaultPrevented,screenX:t.screenX,screenY:t.screenY,clientX:t.clientX,clientY:t.clientY,targetElement:t.target.outerHTML,interactiveElement:e(t.target)})}function e(t){return-1!==["a","audio","button","canvas","details","input","label","option","select","submit","textarea","video"].indexOf(t.nodeName.toLowerCase())||t.hasAttribute("contenteditable")&&"false"!=t.getAttribute("contenteditable").toLowerCase()?t.outerHTML:t.parentElement?e(t.parentElement):null}window.addEventListener("DOMContentLoaded",(function(e){document.body.style.cursor="pointer",document.addEventListener("click",t,!1)}))}},e={};function n(o){var r=e[o];if(void 0!==r)return r.exports;var i=e[o]={exports:{}};return t[o](i,i.exports,n),i.exports}(()=>{"use strict";n(581),window.addEventListener("error",(function(t){webkit.messageHandlers.logError.postMessage({message:t.message,filename:t.filename,line:t.lineno})}),!1),window.addEventListener("load",(function(){window.addEventListener("orientationchange",(function(){s(),f()})),s()}),!1);var t,e,o=0,r=0,i=!1,l=0;function s(){l=0===window.orientation||180==window.orientation?screen.width:screen.height}function c(){return"readium-scroll-on"===document.documentElement.style.getPropertyValue("--USER__scroll").toString().trim()}function d(t){var e=window.scrollX,n=window.innerWidth;return document.scrollingElement.scrollLeft=t,Math.abs(e-t)/n>.01}function a(t){var e=t+1;return e-e%l}function f(){if(!c()){var t=a(window.scrollX+1);document.scrollingElement.scrollLeft=t}}function u(){var t=Array.prototype.slice.call(arguments).join(" ");webkit.messageHandlers.log.postMessage(t)}function h(t,e,n,o){const r=new Range;if(r.setStart(t,e),r.setEnd(n,o),!r.collapsed)return r;E(">>> createOrderedRange COLLAPSED ... RANGE REVERSE?");const i=new Range;if(i.setStart(n,o),i.setEnd(t,e),!i.collapsed)return E(">>> createOrderedRange RANGE REVERSE OK."),r;E(">>> createOrderedRange RANGE REVERSE ALSO COLLAPSED?!")}function g(t){return{cssSelector:t.startContainerElementCssSelector,domRange:{start:{cssSelector:t.startContainerElementCssSelector,textNodeIndex:t.startContainerChildTextNodeIndex,offset:t.startOffset},end:{cssSelector:t.endContainerElementCssSelector,textNodeIndex:t.endContainerChildTextNodeIndex,offset:t.endOffset}}}}function p(t){return t.nodeType!==Node.ELEMENT_NODE?t.localName&&t.localName.toLowerCase()||t.nodeName.toLowerCase():function(t,e){if(t.nodeType!==Node.ELEMENT_NODE)return"";const n=[];let o=t;for(;o;){const e=m(o,!0,o===t);if(!e)break;if(n.push(e.value),e.optimized)break;o=o.parentNode}return n.reverse(),n.join(" > ")}(t)}function m(t,e,n){function o(t){return"#"+r(t)}function r(t){if(/^-?[a-zA-Z_][a-zA-Z0-9_-]*$/.test(t))return t;const e=/^(?:[0-9]|-[0-9-]?)/.test(t),n=t.length-1;return t.replace(/./g,(function(t,o){return e&&0===o||!function(t){return!!/[a-zA-Z0-9_-]/.test(t)||t.charCodeAt(0)>=160}(t)?function(t,e){return"\\"+function(t){let e=t.charCodeAt(0).toString(16);return 1===e.length&&(e="0"+e),e}(t)+(e?"":" ")}(t,o===n):t}))}function i(t){const e=t.getAttribute("class");return e?e.split(/\s+/g).filter(Boolean).map((t=>"$"+t)):[]}if(t.nodeType!==Node.ELEMENT_NODE)return;const l=t.localName&&t.localName.toLowerCase()||t.nodeName.toLowerCase(),s=t,c=s.getAttribute("id");if(e){if(c)return{optimized:!0,value:o(c)};if("body"===l||"head"===l||"html"===l)return{optimized:!0,value:l}}const d=l;if(c)return{optimized:!0,value:d+o(c)};const a=t.parentNode;if(!a||a.nodeType===Node.DOCUMENT_NODE)return{optimized:!0,value:d};const f=i(s),u=[];f.forEach((t=>{u.indexOf(t)<0&&u.push(t)}));let h=!1,g=!1,p=-1,m=-1;const E=a.children;for(let e=0;(-1===p||!g)&&e<E.length;++e){const n=E[e];if(n.nodeType!==Node.ELEMENT_NODE)continue;if(m+=1,n===t){p=m;continue}if(g)continue;if((n.localName&&n.localName.toLowerCase()||n.nodeName.toLowerCase())!==d)continue;h=!0;const o=[];u.forEach((t=>{o.push(t)}));let r=o.length;if(0===r){g=!0;continue}const l=i(n),s=[];l.forEach((t=>{s.indexOf(t)<0&&s.push(t)}));for(const t of s){const e=o.indexOf(t);if(!(e<0||(o.splice(e,1),--r))){g=!0;break}}}let N=d;if(n&&"input"===d&&s.getAttribute("type")&&!s.getAttribute("id")&&!s.getAttribute("class")&&(N+='[type="'+s.getAttribute("type")+'"]'),g)N+=":nth-child("+(p+1)+")";else if(h)for(const t of u)N+="."+r(t.substr(1));return{optimized:!1,value:N}}function E(){u.apply(null,arguments)}function N(t,e){let n=t.getClientRects();const o=[];for(const t of n)o.push({bottom:t.bottom,height:t.height,left:t.left,right:t.right,top:t.top,width:t.width});const r=b(function(t,e){const n=new Set(t);for(const e of t)if(e.width>1&&e.height>1){for(const o of t)if(e!==o&&n.has(o)&&T(o,e,1)){L(),n.delete(e);break}}else L(),n.delete(e);return Array.from(n)}(w(o,1,e)));for(let t=r.length-1;t>=0;t--){const e=r[t];if(!(e.width*e.height>4)){if(!(r.length>1)){L();break}L(),r.splice(t,1)}}return L((o.length,r.length)),r}function w(t,e,n){for(let o=0;o<t.length;o++)for(let r=o+1;r<t.length;r++){const i=t[o],l=t[r];if(i===l){L();continue}const s=O(i.top,l.top,e)&&O(i.bottom,l.bottom,e),c=O(i.left,l.left,e)&&O(i.right,l.right,e),d=!n;if((c&&d||s&&!c)&&x(i,l,e)){L();const o=t.filter((t=>t!==i&&t!==l)),r=C(i,l);return o.push(r),w(o,e,n)}}return t}function C(t,e){const n=Math.min(t.left,e.left),o=Math.max(t.right,e.right),r=Math.min(t.top,e.top),i=Math.max(t.bottom,e.bottom);return{bottom:i,height:i-r,left:n,right:o,top:r,width:o-n}}function T(t,e,n){return y(t,e.left,e.top,n)&&y(t,e.right,e.top,n)&&y(t,e.left,e.bottom,n)&&y(t,e.right,e.bottom,n)}function y(t,e,n,o){return(t.left<e||O(t.left,e,o))&&(t.right>e||O(t.right,e,o))&&(t.top<n||O(t.top,n,o))&&(t.bottom>n||O(t.bottom,n,o))}function b(t){for(let e=0;e<t.length;e++)for(let n=e+1;n<t.length;n++){const o=t[e],r=t[n];if(o!==r){if(x(o,r,-1)){let e,n,i=[];const l=v(o,r);if(1===l.length)i=l,e=o,n=r;else{const t=v(r,o);l.length<t.length?(i=l,e=o,n=r):(i=t,e=r,n=o)}L(i.length);const s=t.filter((t=>t!==e));return Array.prototype.push.apply(s,i),b(s)}}else L()}return t}function v(t,e){const n=function(t,e){const n=Math.max(t.left,e.left),o=Math.min(t.right,e.right),r=Math.max(t.top,e.top),i=Math.min(t.bottom,e.bottom);return{bottom:i,height:Math.max(0,i-r),left:n,right:o,top:r,width:Math.max(0,o-n)}}(e,t);if(0===n.height||0===n.width)return[t];const o=[];{const e={bottom:t.bottom,height:0,left:t.left,right:n.left,top:t.top,width:0};e.width=e.right-e.left,e.height=e.bottom-e.top,0!==e.height&&0!==e.width&&o.push(e)}{const e={bottom:n.top,height:0,left:n.left,right:n.right,top:t.top,width:0};e.width=e.right-e.left,e.height=e.bottom-e.top,0!==e.height&&0!==e.width&&o.push(e)}{const e={bottom:t.bottom,height:0,left:n.left,right:n.right,top:n.bottom,width:0};e.width=e.right-e.left,e.height=e.bottom-e.top,0!==e.height&&0!==e.width&&o.push(e)}{const e={bottom:t.bottom,height:0,left:n.right,right:t.right,top:t.top,width:0};e.width=e.right-e.left,e.height=e.bottom-e.top,0!==e.height&&0!==e.width&&o.push(e)}return o}function x(t,e,n){return(t.left<e.right||n>=0&&O(t.left,e.right,n))&&(e.left<t.right||n>=0&&O(e.left,t.right,n))&&(t.top<e.bottom||n>=0&&O(t.top,e.bottom,n))&&(e.top<t.bottom||n>=0&&O(e.top,t.bottom,n))}function O(t,e,n){return Math.abs(t-e)<=n}function L(){}window.addEventListener("scroll",(function(t){r=window.scrollY/document.scrollingElement.scrollHeight,o=Math.abs(window.scrollX/document.scrollingElement.scrollWidth),0!==document.scrollingElement.scrollWidth&&0!==document.scrollingElement.scrollHeight&&(i||window.requestAnimationFrame((function(){var t;t=(c()?r:o).toString(),webkit.messageHandlers.progressionChanged.postMessage(t),i=!1})),i=!0)})),document.addEventListener("selectionchange",(50,t=function(){var t={},e=document.getSelection();if(e&&e.rangeCount>0){var n=e.getRangeAt(0).getBoundingClientRect();t.text=e.toString().trim(),t.frame={x:n.left,y:n.top,width:n.width,height:n.height}}webkit.messageHandlers.selectionChanged.postMessage(t)},function(){var n=this,o=arguments;function r(){t.apply(n,o),e=null}clearTimeout(e),e=setTimeout(r,50)}));const R="R2_ID_HIGHLIGHTS_CONTAINER",S="R2_CLASS_HIGHLIGHT_AREA",A=[];let I;const M={blue:100,green:50,red:230};function _(){return"readium-scroll-on"===document.documentElement.style.getPropertyValue("--USER__scroll").toString().trim()}window.readium={scrollToId:function(t){var e=document.getElementById(t);if(!e)return!1;if(e.scrollIntoView(),!c()){var n=window.scrollX,o=window.innerWidth;document.scrollingElement.scrollLeft=a(n+o/2)}return!0},scrollToPosition:function(t,e){if(console.log("ScrollToPosition"),t<0||t>1)console.log("InvalidPosition");else if(c()){var n=document.scrollingElement.scrollHeight*t;document.scrollingElement.scrollTop=n}else n=document.scrollingElement.scrollWidth*t*("rtl"==e?-1:1),document.scrollingElement.scrollLeft=a(n)},scrollToText:function(t){function e(t){this.selection=t,this.markedRanges=[]}function n(t){return t.replace(/\s+/g,"")}e.prototype.clear=function(){this.selection.removeAllRanges()},e.prototype.mark=function(){this.markedRanges=[];for(var t=0;t<this.selection.rangeCount;t++)this.markedRanges.push(this.selection.getRangeAt(t))},e.prototype.reset=function(){this.clear();for(var t=0;t<this.markedRanges.length;t++)this.selection.addRange(this.markedRanges[t])},e.prototype.toString=function(){return this.selection.toString()},e.prototype.adjust=function(t,e){for(var n=0;n<=Math.abs(t);n++){var o=t>=0?"forward":"backward";this.selection.modify("move",o,"character")}for(n=0;n<=e;n++)this.selection.modify("extend","forward","character")},e.prototype.isEmpty=function(){return this.selection.isCollapsed},e.prototype.getFirstRange=function(){return this.selection.getRangeAt(0)};var o=t.highlight,r=t.before||"",i=r+o+(t.after||""),l=n(i);if(!o||!l)return!1;var s=new e(window.getSelection());s.clear();for(var d,a,u=!1;window.find(t.highlight,!0)&&!s.isEmpty();){s.mark(),s.adjust(-r.length,i.length);var h=n(s.toString());if(s.reset(),""!==h&&(l.includes(h)||h.includes(l))){u=!0;break}}return!(!u||s.isEmpty()||(d=s.getFirstRange(),a=d.getBoundingClientRect(),c()?document.scrollingElement.scrollTop=a.top+window.scrollY-window.innerHeight/2:(document.scrollingElement.scrollLeft=a.left+window.scrollX,f()),s.clear(),0))},scrollLeft:function(t){var e="rtl"==t,n=document.scrollingElement.scrollWidth,o=window.innerWidth,r=window.scrollX-o,i=e?-(n-o):0;return d(Math.max(r,i))},scrollRight:function(t){var e="rtl"==t,n=document.scrollingElement.scrollWidth,o=window.innerWidth,r=window.scrollX+o,i=e?0:n-o;return d(Math.min(r,i))},setProperty:function(t,e){document.documentElement.style.setProperty(t,e)},removeProperty:function(t){document.documentElement.style.removeProperty(t)},getSelectionRect:function(){try{let t=window.getSelection();if(!t)return;const e=t.getRangeAt(0).getBoundingClientRect();return{screenWidth:window.outerWidth,screenHeight:window.outerHeight,left:e.left,width:e.width,top:e.top,height:e.height}}catch(t){return function(t){webkit.messageHandlers.logError.postMessage({message:t.message})}(t),null}},getCurrentSelectionInfo:function(){const t=window.getSelection();if(!t)return;if(t.isCollapsed)return void E("^^^ SELECTION COLLAPSED.");const e=t.toString();if(0===e.trim().replace(/\n/g," ").replace(/\s\s+/g," ").length)return void E("^^^ SELECTION TEXT EMPTY.");if(!t.anchorNode||!t.focusNode)return;const n=1===t.rangeCount?t.getRangeAt(0):h(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset);if(!n||n.collapsed)return void E("$$$$$$$$$$$$$$$$$ CANNOT GET NON-COLLAPSED SELECTION RANGE?!");const o=function(t,e){const n=t.startContainer.nodeType===Node.ELEMENT_NODE,o=n?t.startContainer:t.startContainer.parentNode&&t.startContainer.parentNode.nodeType===Node.ELEMENT_NODE?t.startContainer.parentNode:void 0;if(!o)return;const r=n?-1:Array.from(o.childNodes).indexOf(t.startContainer);if(r<-1)return;const i=e(o),l=t.endContainer.nodeType===Node.ELEMENT_NODE,s=l?t.endContainer:t.endContainer.parentNode&&t.endContainer.parentNode.nodeType===Node.ELEMENT_NODE?t.endContainer.parentNode:void 0;if(!s)return;const c=l?-1:Array.from(s.childNodes).indexOf(t.endContainer);if(c<-1)return;const d=e(s),a=function(t,e){if(t.nodeType===Node.ELEMENT_NODE&&t===e)return t;if(t.nodeType===Node.ELEMENT_NODE&&t.contains(e))return t;if(e.nodeType===Node.ELEMENT_NODE&&e.contains(t))return e;const n=[];let o=t.parentNode;for(;o&&o.nodeType===Node.ELEMENT_NODE;)n.push(o),o=o.parentNode;const r=[];for(o=e.parentNode;o&&o.nodeType===Node.ELEMENT_NODE;)r.push(o),o=o.parentNode;let i=n.find((t=>r.indexOf(t)>=0));return i||(i=r.find((t=>n.indexOf(t)>=0))),i}(t.startContainer,t.endContainer);if(a){if(t.commonAncestorContainer){const n=t.commonAncestorContainer.nodeType===Node.ELEMENT_NODE?t.commonAncestorContainer:t.commonAncestorContainer.parentNode;n&&n.nodeType===Node.ELEMENT_NODE&&a!==n&&(E(">>>>>> COMMON ANCESTOR CONTAINER DIFF??!"),E(e(a)),E(e(n)))}return{endContainerChildTextNodeIndex:c,endContainerElementCssSelector:d,endOffset:t.endOffset,startContainerChildTextNodeIndex:r,startContainerElementCssSelector:i,startOffset:t.startOffset}}E("^^^ NO RANGE COMMON ANCESTOR?!")}(n,p);if(o)return{locations:g(o),text:{highlight:e}};E("^^^ SELECTION RANGE INFO FAIL?!")},createHighlight:function(t,e,n){return function(t,e,n,o){const r=function(t){const e=t.locations.domRange,n=e.start,o=e.end;return{endContainerChildTextNodeIndex:o.textNodeIndex,endContainerElementCssSelector:o.cssSelector,endOffset:o.offset,startContainerChildTextNodeIndex:n.textNodeIndex,startContainerElementCssSelector:n.cssSelector,startOffset:n.offset}}(t);let i=Date.now();i="R2_HIGHLIGHT_"+i,function(t){let e=-1,n=window.document;A.find(((n,o)=>(e=o,n.id===t)))&&e>=0&&e<A.length&&A.splice(e,1);const o=n.getElementById(t);o&&o.remove()}(i);const l={color:e||M,id:i,pointerInteraction:n,rangeInfo:r};return A.push(l),function(t,e){const n=t.document,o=1/(t.READIUM2&&t.READIUM2.isFixedLayout?t.READIUM2.fxlViewportScale:1),r=n.scrollingElement,i=function(t,e){const n=t.querySelector(e.startContainerElementCssSelector);if(!n)return void E("^^^ convertRangeInfo NO START ELEMENT CSS SELECTOR?!");let o=n;if(e.startContainerChildTextNodeIndex>=0){if(e.startContainerChildTextNodeIndex>=n.childNodes.length)return void E("^^^ convertRangeInfo rangeInfo.startContainerChildTextNodeIndex >= startElement.childNodes.length?!");if(o=n.childNodes[e.startContainerChildTextNodeIndex],o.nodeType!==Node.TEXT_NODE)return void E("^^^ convertRangeInfo startContainer.nodeType !== Node.TEXT_NODE?!")}const r=t.querySelector(e.endContainerElementCssSelector);if(!r)return void E("^^^ convertRangeInfo NO END ELEMENT CSS SELECTOR?!");let i=r;if(e.endContainerChildTextNodeIndex>=0){if(e.endContainerChildTextNodeIndex>=r.childNodes.length)return void E("^^^ convertRangeInfo rangeInfo.endContainerChildTextNodeIndex >= endElement.childNodes.length?!");if(i=r.childNodes[e.endContainerChildTextNodeIndex],i.nodeType!==Node.TEXT_NODE)return void E("^^^ convertRangeInfo endContainer.nodeType !== Node.TEXT_NODE?!")}return h(o,e.startOffset,i,e.endOffset)}(n,e.rangeInfo);if(!i)return;const l=!_(),s=function(t){const e=t.document;return I||(I=e.createElement("div"),I.setAttribute("id",R),I.style.setProperty("pointer-events","none"),e.body.append(I)),I}(t),c=n.createElement("div");c.setAttribute("id",e.id),c.setAttribute("class","R2_CLASS_HIGHLIGHT_CONTAINER"),c.style.setProperty("pointer-events","none"),e.pointerInteraction&&c.setAttribute("data-click","1");const d=n.body.getBoundingClientRect(),a=N(i,false);let f,u,g="";f=l?-r.scrollLeft:d.left,u=l?-r.scrollTop:d.top;for(const t of a){const r=n.createElement("div");r.setAttribute("class",S),r.setAttribute("style",`border-radius: 3px !important; background-color: rgba(${e.color.red}, ${e.color.green}, ${e.color.blue}, 0.3) !important; ${g}`),r.style.setProperty("pointer-events","none"),r.style.position=l?"absolute":"fixed",r.scale=o,r.rect={height:t.height,left:t.left-f,top:t.top-u,width:t.width},r.style.width=r.rect.width*o+"px",r.style.height=r.rect.height*o+"px",r.style.left=r.rect.left*o+"px",r.style.top=r.rect.top*o+"px",c.append(r),false}const p=n.createElement("div");p.setAttribute("class","R2_CLASS_HIGHLIGHT_BOUNDING_AREA"),p.style.setProperty("pointer-events","none"),p.style.position=l?"fixed":"absolute",p.scale=o;const m=i.getBoundingClientRect();p.rect={height:m.height,left:m.left-f,top:m.top-u,width:m.width},p.style.width=p.rect.width*o+"px",p.style.height=p.rect.height*o+"px",p.style.left=p.rect.left*o+"px",p.style.top=p.rect.top*o+"px",c.append(p),s.append(c)}(window,l),l}(t,e,n)}}})()})();
//# sourceMappingURL=readium-fixed.js.map